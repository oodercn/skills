# Ooder Agent Platform v0.8.0 架构设计总览

## 1. 概述

### 1.1 版本信息

| 项目 | 值 |
|------|-----|
| 版本 | v0.8.0 |
| 发布日期 | 2026-03-08 (计划) |
| 架构代号 | CAP-Driven Architecture |
| 主要变更 | Scene=Agent、CAP标准化、能力驱动发现 |

### 1.2 设计目标

- **防止 Skills 膨胀**: 通过 CAP 标准化，避免重复开发
- **向后兼容**: CAP 版本化管理，保证驱动接口稳定
- **能力复用**: 同一 CAP 可被多个 Skill 实现，按需选择
- **AI 友好**: scene.md 和 cap.md 提供详细约束，AI 可理解扩展
- **离线优先**: 所有 CAP 必须支持离线降级实现

### 1.3 核心架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Ooder Agent Platform v0.8.0 架构                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        应用层 (Application)                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│   │
│  │  │  个人网络   │  │  部门分享   │  │  公司管理   │  │  公共社区   ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        场景层 (Scene = Agent)                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│   │
│  │  │  消息场景   │  │  认证场景   │  │  存储场景   │  │  监控场景   ││   │
│  │  │  (Agent)    │  │  (Agent)    │  │  (Agent)    │  │  (Agent)    ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘│   │
│  │                              │                                      │   │
│  │                    scene.yaml + scene.md                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        能力层 (CAP Registry)                         │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │ 系统区 (00-3F) │ 通用区 (40-9F) │ 扩展区 (A0-FF)              │ │   │
│  │  │ 64 个          │ 96 个          │ 96 个                       │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                              │                                      │   │
│  │                    cap.yaml + cap.md + 接口契约                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        技能层 (Skills)                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│   │
│  │  │skill-msg    │  │skill-org    │  │skill-vfs    │  │skill-monitor││   │
│  │  │ implements  │  │ implements  │  │ implements  │  │ implements  ││   │
│  │  │ CAP-40,41   │  │ CAP-50,51   │  │ CAP-60,61   │  │ CAP-70,71   ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        基础设施层 (Infrastructure)                   │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │SceneEngine│ │SkillCenter│ │ AgentSDK  │ │ EventBus  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ UDP/DHT   │ │  VFS      │ │ Offline   │ │ Security  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心概念

### 2.1 Scene = Agent

场景是特殊的智能体，具备以下属性：

| 属性 | 说明 |
|------|------|
| AgentID | scene-{sceneName}-{uuid} |
| 类型 | PRIMARY / BACKUP / COLLABORATIVE |
| 自动启动 | 支持 |
| 高可用 | 支持 HA 模式 |
| 离线支持 | 支持 |

### 2.2 CAP (Capability)

能力是标准化的接口定义：

| 属性 | 说明 |
|------|------|
| CAP ID | 16进制地址 (00-FF) |
| 名称 | 如 MSG_SEND |
| 接口契约 | 标准化的请求/响应格式 |
| 离线要求 | 必须支持降级实现 |
| 版本 | 语义化版本 |

### 2.3 Skill

技能是 CAP 的具体实现：

| 属性 | 说明 |
|------|------|
| 实现能力 | 声明实现的 CAP 列表 |
| 契约合规 | 必须符合 CAP 定义 |
| 降级实现 | 必须实现 Fallback |
| 调用类型 | http / local-jar / grpc / websocket / udp |

---

## 3. CAP 地址空间

### 3.1 地址划分

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CAP 地址空间 (256 = 00-FF)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  系统区 (00-3F) - 64个                                                      │
│  ─────────────────────────────────────────────                              │
│  00-0F: 核心系统能力                                                        │
│        00: CAP_REGISTRY      能力注册表                                     │
│        01: CAP_DISCOVERY     能力发现                                       │
│        02: CAP_AUTH          能力认证                                       │
│        03: CAP_ROUTING       能力路由                                       │
│                                                                             │
│  10-1F: Agent 核心能力                                                      │
│        10: AGENT_REGISTER    Agent 注册                                     │
│        11: AGENT_HEARTBEAT   Agent 心跳                                     │
│        12: AGENT_FAILOVER    Agent 故障切换                                 │
│                                                                             │
│  20-2F: 场景组能力                                                          │
│        20: SCENE_JOIN        加入场景                                       │
│        21: SCENE_LEAVE       离开场景                                       │
│        22: SCENE_SYNC        场景同步                                       │
│                                                                             │
│  30-3F: VFS 核心能力                                                        │
│        30: VFS_READ          文件读取                                       │
│        31: VFS_WRITE         文件写入                                       │
│                                                                             │
│  通用区 (40-9F) - 96个                                                      │
│  ─────────────────────────────────────────────                              │
│  40-4F: 消息通讯能力                                                        │
│        40: MSG_SEND          消息发送                                       │
│        41: MSG_RECEIVE       消息接收                                       │
│        42: MSG_TOPIC         Topic 管理                                     │
│        43: MSG_QUEUE         消息队列                                       │
│                                                                             │
│  50-5F: 组织管理能力                                                        │
│        50: ORG_AUTH          组织认证                                       │
│        51: ORG_USER          用户管理                                       │
│        52: ORG_DEPT          部门管理                                       │
│                                                                             │
│  60-6F: 存储能力                                                            │
│        60: STORAGE_READ      存储读取                                       │
│        61: STORAGE_WRITE     存储写入                                       │
│                                                                             │
│  70-7F: 监控能力                                                            │
│        70: MONITOR_METRICS   指标采集                                       │
│        71: MONITOR_ALERT     告警管理                                       │
│                                                                             │
│  80-8F: 安全能力                                                            │
│        80: SECURITY_AUTH     安全认证                                       │
│        81: SECURITY_AUDIT    安全审计                                       │
│                                                                             │
│  90-9F: 支付能力                                                            │
│        90: PAYMENT_CREATE    创建支付                                       │
│        91: PAYMENT_QUERY     查询支付                                       │
│                                                                             │
│  扩展区 (A0-FF) - 96个                                                      │
│  ─────────────────────────────────────────────                              │
│  A0-AF: 媒体发布能力                                                        │
│        A0: MEDIA_WECHAT      微信公众号                                     │
│        A1: MEDIA_WEIBO       微博                                           │
│                                                                             │
│  B0-BF: AI/LLM 能力                                                         │
│        B0: LLM_CHAT          LLM 对话                                       │
│        B1: LLM_EMBED         LLM 嵌入                                       │
│                                                                             │
│  C0-FF: 预留扩展区                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 发现流程

### 4.1 新发现流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    能力发现流程 v0.8.0                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 启动雷达扫描                                                            │
│     │                                                                        │
│     ├── 同步 Scene 索引                                                     │
│     ├── 同步 CAP 注册表                                                     │
│     ├── 同步 Skill 索引                                                     │
│     └── 缓存到本地                                                          │
│                                                                             │
│  2. 展示选择界面                                                            │
│     │                                                                        │
│     ├── 按场景分类浏览                                                      │
│     ├── 按能力分类浏览                                                      │
│     └── 搜索功能                                                            │
│                                                                             │
│  3. 用户选择场景                                                            │
│     │                                                                        │
│     ├── 展示场景详情                                                        │
│     ├── 展示可用 Skill 列表                                                 │
│     └── 用户选择 Skill                                                      │
│                                                                             │
│  4. 自动安装场景                                                            │
│     │                                                                        │
│     ├── 下载 Skill 包                                                       │
│     ├── 验证 CAP 契约                                                       │
│     ├── 安装依赖 Skills                                                     │
│     ├── 初始化 Scene Agent                                                  │
│     └── 激活场景                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 发现方式应用

| 发现方式 | 个人网络 | 部门分享 | 公司管理 | 公共社区 |
|----------|----------|----------|----------|----------|
| UDP Broadcast | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | ⭐ |
| mDNS/DNS-SD | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ | ⭐ |
| DHT (Kademlia) | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| SkillCenter API | ⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| GitHub/Gitee | ⭐ | ⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 5. 仓库结构

### 5.1 单仓库设计

采用单仓库（Monorepo）结构，统一管理CAP注册表、场景模板和Skills实现。

```
github.com/ooderCN/ooder-skills/
│
├── README.md
├── pom.xml                          # 父POM，统一版本
├── CODEOWNERS                       # 目录级权限控制
│
├── registry/                        # CAP注册表
│   ├── cap-index.yaml               # CAP总索引
│   ├── system/                      # 系统区 (00-3F)
│   │   ├── 00-cap-registry/
│   │   │   ├── cap.yaml
│   │   │   └── cap.md
│   │   └── ...
│   ├── common/                      # 通用区 (40-9F)
│   │   ├── 40-im-send/
│   │   └── ...
│   └── extension/                   # 扩展区 (A0-FF)
│       ├── a0-media-wechat/
│       └── ...
│
├── scenes/                          # 场景模板
│   ├── scene-index.yaml             # 场景总索引
│   ├── messaging/                   # 消息场景
│   │   ├── scene.yaml
│   │   └── scene.md
│   ├── authentication/              # 认证场景
│   ├── storage/                     # 存储场景
│   └── ...
│
├── skills/                          # Skills实现
│   ├── skill-index.yaml             # Skill总索引
│   ├── skill-agent/
│   │   ├── pom.xml
│   │   ├── skill-manifest.yaml
│   │   └── src/
│   ├── skill-msg-service/
│   ├── skill-audit/
│   └── ...
│
├── skill-common/                    # 公共组件
│   └── src/
│
├── tools/                           # 工具
│   ├── skill-generator/             # Skill生成器
│   ├── cap-validator/               # CAP验证器
│   └── index-builder/               # 索引构建器
│
└── docs/                            # 文档
    ├── architecture/
    ├── guides/
    └── v0.8.0/
```

### 5.2 单仓库优势

| 优势 | 说明 |
|------|------|
| 原子性变更 | 一个PR可同时更新CAP定义和Skill实现 |
| 版本一致性 | 统一版本号，无版本协调问题 |
| 发现效率 | git clone一次获取全部内容 |
| 离线优先 | 完整的本地索引，无需网络 |
| CI/CD简化 | 单一工作流，统一测试发布 |
| 贡献者友好 | Fork一个仓库即可贡献 |

### 5.3 权限控制

通过CODEOWNERS文件实现目录级权限控制：

```
# CAP注册表 - 架构组维护
/registry/ @ooderCN/architecture-team

# 场景模板 - 架构组维护
/scenes/ @ooderCN/architecture-team

# Skills - 开发组维护
/skills/ @ooderCN/dev-team

# 公共组件 - 核心组维护
/skill-common/ @ooderCN/core-team
```

---

## 6. 版本兼容策略

### 6.1 CAP 版本兼容

| 版本变更 | 兼容性 | 说明 |
|----------|--------|------|
| 1.0 → 1.1 | ✅ 兼容 | 新增可选字段 |
| 1.0 → 1.2 | ✅ 兼容 | 新增可选能力 |
| 1.0 → 2.0 | ❌ 不兼容 | 接口重构，需适配器 |

### 6.2 Skill 版本兼容

| Skill 版本 | SDK 版本 | 协议版本 |
|------------|----------|----------|
| 0.8.x | 0.8.0 | v0.8.0 |
| 0.7.x | 0.7.3 | v0.7.3 |

---

## 7. 相关文档

- [CAP 注册表规范](./CAP-REGISTRY-SPEC.md)
- [场景引擎规范](./SCENE-ENGINE-SPEC.md)
- [能力发现协议](./CAPABILITY-DISCOVERY-PROTOCOL.md)
- [团队协作任务](./TEAM-COLLABORATION-TASKS.md)

---

## 8. Agent 体系架构

### 8.1 Agent 层次结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    完整 Agent 体系                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  物理层 (Physical Layer)                                                    │
│  ─────────────────────────────────────────────────────────────────────────  │
│  PlaceAgent (物理位置)                                                      │
│  ├── 每个 Place 一个 McpAgent（本地自治）                                   │
│  ├── 跨 McpAgent 通过北向协议协同                                           │
│  └── 存储：本地优先 + 策略性备份                                            │
│                                                                             │
│  ZoneAgent (区域)                                                           │
│  ├── Place 内的功能区域                                                    │
│  └── 包含多个 Device                                                       │
│                                                                             │
│  Device (设备)                                                              │
│  ├── 物理实体，非 Agent                                                    │
│  ├── 分类：固定设备、移动设备、电池设备                                    │
│  └── 与 Agent 绑定（用户操作结果）                                         │
│                                                                             │
│  链路层 (Link Layer)                                                        │
│  ─────────────────────────────────────────────────────────────────────────  │
│  RouteAgent (路由代理)                                                      │
│  ├── 链路控制、本地执行                                                    │
│  ├── 存储：本地存储，离线可用                                              │
│  ├── 部署：默认规则 + 用户参与管理                                         │
│  └── 不直接与用户交互                                                      │
│                                                                             │
│  McpAgent (中心协调代理)                                                    │
│  ├── 每个 Place 一个，本地自治                                             │
│  ├── 用户交互入口                                                          │
│  ├── 设备入网管理                                                          │
│  └── 场景决策协调                                                          │
│                                                                             │
│  应用层 (Application Layer)                                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│  SceneAgent (场景代理)                                                      │
│  ├── 用户定义的工作场景                                                    │
│  ├── 包含多个 WorkerAgent                                                  │
│  ├── 决策：自动/半自动/手动                                                │
│  └── 需要 CAP 时向 McpAgent 请求                                           │
│                                                                             │
│  WorkerAgent (工作代理)                                                     │
│  ├── 用户看到的"助手"                                                      │
│  ├── 封装 Skill + CapProvider                                              │
│  └── 通过 agentId 绑定 Device                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Agent 类型定义

| Agent类型 | 层次 | 职责 | 示例 |
|-----------|------|------|------|
| PlaceAgent | 物理层 | 物理位置管理 | 北京家、上海办公室 |
| ZoneAgent | 物理层 | 区域管理 | 客厅、书房、机房 |
| McpAgent | 链路层 | 中心协调、用户交互 | 网关 |
| RouteAgent | 链路层 | 链路控制、本地执行 | 开关、路由器 |
| SceneAgent | 应用层 | 场景编排、任务协调 | 博文发布场景 |
| WorkerAgent | 应用层 | 任务执行、能力调用 | 资料助手、写作助手 |

### 8.3 Device 与 Agent 的关系

```
Device (物理实体)                Agent (逻辑实体)
─────────────────────────────────────────────────────────────

Device: NAS                      Agent-1: RouteAgent (存储链路)
├── IP: 192.168.1.100           Agent-2: StorageCap (存储能力)
├── MAC: AA:BB:CC:DD:EE:FF      Agent-3: ComputeCap (计算能力)
├── 类型: 固定设备              
└── 心跳: 30秒                  

Device: 手机                     Agent-1: RouteAgent (移动链路)
├── IP: 192.168.1.101           Agent-2: NotifyCap (通知能力)
├── 类型: 移动设备              
├── 心跳: 30秒/60秒(休眠)       
└── 支持休眠唤醒                

绑定关系：
├── agentId: 逻辑标识，稳定不变
├── deviceId: 物理标识，可能变化
└── agentId ↔ deviceId 绑定，解决设备更替问题
```

---

## 9. Command 体系

### 9.1 Command 概念

```
┌─────────────────────────────────────────────────────────────────┐
│                    Command 定义                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Command 组成：命令 + 参数                                      │
│                                                                 │
│  Command 特点：                                                 │
│  ├── 各层之间的共同语言                                         │
│  ├── 具备直达 CAP 的能力                                       │
│  ├── 仅适用原子能力                                            │
│  └── 指令明确无歧义                                            │
│                                                                 │
│  Command 来源无关：                                             │
│  ├── 场景发送                                                   │
│  ├── 其他设备触发                                               │
│  └── 用户通过网关人工干预                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Command 分类

| 类型 | 命名规范 | 说明 | 示例 |
|------|----------|------|------|
| 标准命令 | standard://{commandId} | 参考行业标准 | on, off, toggle, set, get |
| 自定义命令 | custom://{namespace}/{commandId} | 用户/开发者定义 | custom://mycompany/special |

### 9.3 CAP 命令定义

```yaml
cap:
  id: "01"
  name: "Switch"
  spec:
    standardCommands:
      - on
      - off
      - toggle
    customCommands:
      allowed: true
      namespace: "custom"
    commandOptions:
      allowParams: true
      allowTimeout: true
      allowPriority: true
```

---

## 10. 绑定与链路

### 10.1 绑定目的

```
绑定 = 确定性执行 + 离线可运行保障

绑定后：
├── 无需广播，直接处理
├── 与 McpAgent 断开仍可执行
├── 链路确定性（源→目的已确定）
└── 有问题再执行广播中转策略
```

### 10.2 绑定类型

| 类型 | 说明 | 示例 |
|------|------|------|
| 强绑定 | 不可拆分，只能故障设定 | 灯↔开关、温湿度传感器↔采集器 |
| 弱绑定 | 用户可调整 | 场景↔设备 |

### 10.3 链路定义

```
链路 = 途径 + 设备内部地址 + CAP路由
运输物 = CAP 对应的 Command

链路属性：
├── linkId: 唯一标识
├── sourceCap: 源CAP
├── targetDevice: 目标设备
├── targetCap: 目标CAP
├── status: ACTIVE | SUSPENDED | FAILED
└── 绑定本身也是 Command
```

### 10.4 离线执行流程

```
Step 1: 直接执行（绑定路径）
├── 发送 Command 到目标设备
└── 成功 → 结束

Step 2: 失败检测
├── 查询链路状态，确认物理链路是否正常
├── 再发送确认，排除心跳期突然故障
└── 确认故障类型

Step 3: 状态处理
├── 离线状态：尝试后重置状态
├── 故障状态：不再路由，避免风暴
└── 等待下一个心跳周期后恢复
```

---

## 11. 心跳与状态管理

### 11.1 设备分类心跳

| 设备类型 | 正常周期 | 休眠周期 | 离线判定 |
|----------|----------|----------|----------|
| 固定设备 (PC、NAS、路由器) | 30秒 | 无 | 连续3次丢失 |
| 移动设备 (手机、平板) | 30秒 | 60秒 | 连续3次丢失 |
| 电池设备 (传感器) | 60秒 | 120秒 | 连续3次丢失 |
| 特殊高频设备 | 可配置 | - | 连续3次丢失 |

### 11.2 状态恢复机制

```
心跳丢失 → 离线：
├── 连续3次心跳丢失
├── 标记为离线
└── 通知 McpAgent

离线恢复 → 重新入网：
├── 离线后心跳恢复
├── 提出重新入网请求
├── 用户批准（如需要）
└── 更新安全密钥

冷启动 → 入网：
├── 设备首次启动
├── 发起入网请求
├── 用户批准
└── 分配安全密钥
```

### 11.3 状态定义

| 状态 | 说明 | 处理 |
|------|------|------|
| 在线 | 设备在线且可用 | 正常执行 |
| 离线 | 设备无响应 | 尝试重连，可恢复 |
| 故障 | 有心跳但未响应命令，或接收命令但执行结果未反馈 | 不再路由，避免风暴 |

---

## 12. 北向/南向协议

### 12.1 北向协议（用户/应用层）

```
职责：
├── 用户交互
├── 场景管理
├── Agent 与 Device 绑定管理
├── 跨 McpAgent 协同
└── 用户参与的操作

上报消息：
├── AGENT_ANNOUNCE: Agent 启动广播
├── CAP_SHARE: 能力分享广播
├── SCENE_CREATE: 场景创建广播
├── CAP_HANDOVER: 能力转移请求
└── CAP_SYNC_REQUEST: 能力同步请求
```

### 12.2 南向协议（设备层）

```
职责：
├── 设备发现
├── Command 传输
├── 状态上报
├── 链路维护
└── 心跳管理

核心职责：保障离线可运行
├── 本地链路维护
├── 绑定关系执行
├── 心跳管理
├── 状态缓存
└── 故障隔离

不处理：
├── Agent 与 Device 绑定管理
├── 用户参与的操作
└── 跨 McpAgent 协同
```

---

## 13. 安全机制

### 13.1 入网安全

```
冷启动入网：
├── 设备首次启动
├── 发起入网请求
├── 用户批准
└── 分配安全密钥

离线恢复入网：
├── 离线后心跳恢复
├── 提出重新入网请求
├── 用户批准（如需要）
└── 更新安全密钥
```

### 13.2 执行安全

```
├── 敏感操作需用户确认
├── 故障隔离，避免风暴
└── 状态监控与审计
```

---

## 14. 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v0.8.0 | 2026-03-08 | CAP驱动架构、Scene=Agent、能力发现重构、完整Agent体系 |
| v0.7.3 | 2026-02-20 | 离线支持、事件驱动、Driver Proxy |
