# Ooder Agent Platform v0.8.0 架构设计总览

## 1. 概述

### 1.1 版本信息

| 项目 | 值 |
|------|-----|
| 版本 | v0.8.0 |
| 发布日期 | 2026-03-08 (计划) |
| 架构代号 | CAP-Driven Architecture |
| 主要变更 | Scene=Agent、CAP标准化、能力驱动发现 |

### 1.2 设计目标

- **防止 Skills 膨胀**: 通过 CAP 标准化，避免重复开发
- **向后兼容**: CAP 版本化管理，保证驱动接口稳定
- **能力复用**: 同一 CAP 可被多个 Skill 实现，按需选择
- **AI 友好**: scene.md 和 cap.md 提供详细约束，AI 可理解扩展
- **离线优先**: 所有 CAP 必须支持离线降级实现

### 1.3 核心架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Ooder Agent Platform v0.8.0 架构                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        应用层 (Application)                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│   │
│  │  │  个人网络   │  │  部门分享   │  │  公司管理   │  │  公共社区   ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        场景层 (Scene = Agent)                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│   │
│  │  │  消息场景   │  │  认证场景   │  │  存储场景   │  │  监控场景   ││   │
│  │  │  (Agent)    │  │  (Agent)    │  │  (Agent)    │  │  (Agent)    ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘│   │
│  │                              │                                      │   │
│  │                    scene.yaml + scene.md                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        能力层 (CAP Registry)                         │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │ 系统区 (00-3F) │ 通用区 (40-9F) │ 扩展区 (A0-FF)              │ │   │
│  │  │ 64 个          │ 96 个          │ 96 个                       │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                              │                                      │   │
│  │                    cap.yaml + cap.md + 接口契约                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        技能层 (Skills)                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│   │
│  │  │skill-msg    │  │skill-org    │  │skill-vfs    │  │skill-monitor││   │
│  │  │ implements  │  │ implements  │  │ implements  │  │ implements  ││   │
│  │  │ CAP-40,41   │  │ CAP-50,51   │  │ CAP-60,61   │  │ CAP-70,71   ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        基础设施层 (Infrastructure)                   │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │SceneEngine│ │SkillCenter│ │ AgentSDK  │ │ EventBus  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ UDP/DHT   │ │  VFS      │ │ Offline   │ │ Security  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心概念

### 2.1 Scene = Agent

场景是特殊的智能体，具备以下属性：

| 属性 | 说明 |
|------|------|
| AgentID | scene-{sceneName}-{uuid} |
| 类型 | PRIMARY / BACKUP / COLLABORATIVE |
| 自动启动 | 支持 |
| 高可用 | 支持 HA 模式 |
| 离线支持 | 支持 |

### 2.2 CAP (Capability)

能力是标准化的接口定义：

| 属性 | 说明 |
|------|------|
| CAP ID | 16进制地址 (00-FF) |
| 名称 | 如 MSG_SEND |
| 接口契约 | 标准化的请求/响应格式 |
| 离线要求 | 必须支持降级实现 |
| 版本 | 语义化版本 |

### 2.3 Skill

技能是 CAP 的具体实现：

| 属性 | 说明 |
|------|------|
| 实现能力 | 声明实现的 CAP 列表 |
| 契约合规 | 必须符合 CAP 定义 |
| 降级实现 | 必须实现 Fallback |
| 调用类型 | http / local-jar / grpc / websocket / udp |

---

## 3. CAP 地址空间

### 3.1 地址划分

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CAP 地址空间 (256 = 00-FF)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  系统区 (00-3F) - 64个                                                      │
│  ─────────────────────────────────────────────                              │
│  00-0F: 核心系统能力                                                        │
│        00: CAP_REGISTRY      能力注册表                                     │
│        01: CAP_DISCOVERY     能力发现                                       │
│        02: CAP_AUTH          能力认证                                       │
│        03: CAP_ROUTING       能力路由                                       │
│                                                                             │
│  10-1F: Agent 核心能力                                                      │
│        10: AGENT_REGISTER    Agent 注册                                     │
│        11: AGENT_HEARTBEAT   Agent 心跳                                     │
│        12: AGENT_FAILOVER    Agent 故障切换                                 │
│                                                                             │
│  20-2F: 场景组能力                                                          │
│        20: SCENE_JOIN        加入场景                                       │
│        21: SCENE_LEAVE       离开场景                                       │
│        22: SCENE_SYNC        场景同步                                       │
│                                                                             │
│  30-3F: VFS 核心能力                                                        │
│        30: VFS_READ          文件读取                                       │
│        31: VFS_WRITE         文件写入                                       │
│                                                                             │
│  通用区 (40-9F) - 96个                                                      │
│  ─────────────────────────────────────────────                              │
│  40-4F: 消息通讯能力                                                        │
│        40: MSG_SEND          消息发送                                       │
│        41: MSG_RECEIVE       消息接收                                       │
│        42: MSG_TOPIC         Topic 管理                                     │
│        43: MSG_QUEUE         消息队列                                       │
│                                                                             │
│  50-5F: 组织管理能力                                                        │
│        50: ORG_AUTH          组织认证                                       │
│        51: ORG_USER          用户管理                                       │
│        52: ORG_DEPT          部门管理                                       │
│                                                                             │
│  60-6F: 存储能力                                                            │
│        60: STORAGE_READ      存储读取                                       │
│        61: STORAGE_WRITE     存储写入                                       │
│                                                                             │
│  70-7F: 监控能力                                                            │
│        70: MONITOR_METRICS   指标采集                                       │
│        71: MONITOR_ALERT     告警管理                                       │
│                                                                             │
│  80-8F: 安全能力                                                            │
│        80: SECURITY_AUTH     安全认证                                       │
│        81: SECURITY_AUDIT    安全审计                                       │
│                                                                             │
│  90-9F: 支付能力                                                            │
│        90: PAYMENT_CREATE    创建支付                                       │
│        91: PAYMENT_QUERY     查询支付                                       │
│                                                                             │
│  扩展区 (A0-FF) - 96个                                                      │
│  ─────────────────────────────────────────────                              │
│  A0-AF: 媒体发布能力                                                        │
│        A0: MEDIA_WECHAT      微信公众号                                     │
│        A1: MEDIA_WEIBO       微博                                           │
│                                                                             │
│  B0-BF: AI/LLM 能力                                                         │
│        B0: LLM_CHAT          LLM 对话                                       │
│        B1: LLM_EMBED         LLM 嵌入                                       │
│                                                                             │
│  C0-FF: 预留扩展区                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 发现流程

### 4.1 新发现流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    能力发现流程 v0.8.0                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 启动雷达扫描                                                            │
│     │                                                                        │
│     ├── 同步 Scene 索引                                                     │
│     ├── 同步 CAP 注册表                                                     │
│     ├── 同步 Skill 索引                                                     │
│     └── 缓存到本地                                                          │
│                                                                             │
│  2. 展示选择界面                                                            │
│     │                                                                        │
│     ├── 按场景分类浏览                                                      │
│     ├── 按能力分类浏览                                                      │
│     └── 搜索功能                                                            │
│                                                                             │
│  3. 用户选择场景                                                            │
│     │                                                                        │
│     ├── 展示场景详情                                                        │
│     ├── 展示可用 Skill 列表                                                 │
│     └── 用户选择 Skill                                                      │
│                                                                             │
│  4. 自动安装场景                                                            │
│     │                                                                        │
│     ├── 下载 Skill 包                                                       │
│     ├── 验证 CAP 契约                                                       │
│     ├── 安装依赖 Skills                                                     │
│     ├── 初始化 Scene Agent                                                  │
│     └── 激活场景                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 发现方式应用

| 发现方式 | 个人网络 | 部门分享 | 公司管理 | 公共社区 |
|----------|----------|----------|----------|----------|
| UDP Broadcast | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | ⭐ |
| mDNS/DNS-SD | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ | ⭐ |
| DHT (Kademlia) | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| SkillCenter API | ⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| GitHub/Gitee | ⭐ | ⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 5. 仓库结构

```
github.com/ooderCN/
├── ooder-scenes/                          # 场景仓库
│   ├── scene-index.yaml                   # 场景索引
│   ├── scenes/                            # 场景定义
│   │   ├── messaging/
│   │   │   ├── scene.yaml
│   │   │   └── scene.md
│   │   └── ...
│   └── assets/
│
├── ooder-cap-registry/                    # CAP 注册表仓库
│   ├── cap-index.yaml                     # CAP 索引
│   ├── system/                            # 系统区 (00-3F)
│   ├── common/                            # 通用区 (40-9F)
│   └── extension/                         # 扩展区 (A0-FF)
│
├── ooder-skills/                          # Skills 仓库（现有）
│   ├── skill-index.yaml
│   └── skills/
│
└── ooder-skillcenter/                     # SkillCenter 服务
    └── api/
```

---

## 6. 版本兼容策略

### 6.1 CAP 版本兼容

| 版本变更 | 兼容性 | 说明 |
|----------|--------|------|
| 1.0 → 1.1 | ✅ 兼容 | 新增可选字段 |
| 1.0 → 1.2 | ✅ 兼容 | 新增可选能力 |
| 1.0 → 2.0 | ❌ 不兼容 | 接口重构，需适配器 |

### 6.2 Skill 版本兼容

| Skill 版本 | SDK 版本 | 协议版本 |
|------------|----------|----------|
| 0.8.x | 0.8.0 | v0.8.0 |
| 0.7.x | 0.7.3 | v0.7.3 |

---

## 7. 相关文档

- [CAP 注册表规范](./CAP-REGISTRY-SPEC.md)
- [场景引擎规范](./SCENE-ENGINE-SPEC.md)
- [能力发现协议](./CAPABILITY-DISCOVERY-PROTOCOL.md)
- [团队协作任务](./TEAM-COLLABORATION-TASKS.md)

---

## 8. 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v0.8.0 | 2026-03-08 | CAP驱动架构、Scene=Agent、能力发现重构 |
| v0.7.3 | 2026-02-20 | 离线支持、事件驱动、Driver Proxy |
